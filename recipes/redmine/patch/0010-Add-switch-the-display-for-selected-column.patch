From e2dc11e72b07f45036e2a7a2129b19253018e05f Mon Sep 17 00:00:00 2001
From: ishikawa <ishikawa@farend.jp>
Date: Wed, 31 Jan 2018 09:32:53 +0900
Subject: [PATCH 10/11] Add switch the display for selected column

---
 app/models/issue_query.rb                  | 10 ++++++
 app/views/gantts/show.html.erb             |  8 +++--
 app/views/queries/_form.html.erb           |  1 +
 config/locales/en.yml                      |  1 +
 public/javascripts/gantt.js                | 42 ++++++++++++----------
 test/functional/queries_controller_test.rb |  8 +++--
 6 files changed, 48 insertions(+), 22 deletions(-)

diff --git a/app/models/issue_query.rb b/app/models/issue_query.rb
index f852c144e..0cdd9e693 100644
--- a/app/models/issue_query.rb
+++ b/app/models/issue_query.rb
@@ -73,10 +73,20 @@ class IssueQuery < Query
     options[:draw_progress_line] = (arg == '1' ? '1' : nil)
   end
 
+  def draw_selected_columns
+    r = options[:draw_selected_columns]
+    r == '1'
+  end
+
+  def draw_selected_columns=(arg)
+    options[:draw_selected_columns] = (arg == '1' ? '1' : nil)
+  end
+
   def build_from_params(params)
     super
     self.draw_relations = params[:draw_relations] || (params[:query] && params[:query][:draw_relations])
     self.draw_progress_line = params[:draw_progress_line] || (params[:query] && params[:query][:draw_progress_line])
+    self.draw_selected_columns = params[:draw_selected_columns] || (params[:query] && params[:query][:draw_selected_columns])
     self
   end
 
diff --git a/app/views/gantts/show.html.erb b/app/views/gantts/show.html.erb
index 09046fe71..3b7334d0b 100644
--- a/app/views/gantts/show.html.erb
+++ b/app/views/gantts/show.html.erb
@@ -34,6 +34,10 @@
               <legend>
                 <%= l(:field_column_names) %>
               </legend>
+              <label for="draw_selected_columns">
+                <%= check_box 'query', 'draw_selected_columns', :id => 'draw_selected_columns' %>
+                  <%= l(:label_display) %>
+              </label>
               <%= render_query_columns_selection(@query) %>
             </fieldset>
           </td>
@@ -414,8 +418,8 @@
     disable_unavailable_columns('<%= Redmine::Helpers::Gantt::UNAVAILABLE_COLUMNS.map{|column| column.to_s }.join(',') %>'.split(','));
     drawGanttHandler();
     resizableSubjectColumn();
-    $("#draw_relations").change(drawGanttHandler);
-    $("#draw_progress_line").change(drawGanttHandler);
+    drawSelectedColumns();
+    $("#draw_relations, #draw_progress_line, #draw_selected_columns").change(drawGanttHandler);
   });
   $(window).resize(function() {
     drawGanttHandler();
diff --git a/app/views/queries/_form.html.erb b/app/views/queries/_form.html.erb
index f424e103c..094860865 100644
--- a/app/views/queries/_form.html.erb
+++ b/app/views/queries/_form.html.erb
@@ -42,6 +42,7 @@
   <p><label><%= l(:button_show) %></label>
   <label class="inline"><%= check_box_tag "query[draw_relations]", "1", @query.draw_relations %> <%= l(:label_related_issues) %></label>
   <label class="inline"><%= check_box_tag "query[draw_progress_line]", "1", @query.draw_progress_line %> <%= l(:label_gantt_progress_line) %></label>
+  <label class="inline"><%= check_box_tag "query[draw_selected_columns]", "1", @query.draw_selected_columns %> <%= l(:label_gantt_selected_columns) %></label>
   </p>
 </fieldset>
 <% end %>
diff --git a/config/locales/en.yml b/config/locales/en.yml
index df57a57f3..a0c007503 100644
--- a/config/locales/en.yml
+++ b/config/locales/en.yml
@@ -1019,6 +1019,7 @@ en:
   label_font_monospace: Monospaced font
   label_font_proportional: Proportional font
   label_last_notes: Last notes
+  label_gantt_selected_columns: Selected columns
 
   button_login: Login
   button_submit: Submit
diff --git a/public/javascripts/gantt.js b/public/javascripts/gantt.js
index 17a192970..60f02b298 100644
--- a/public/javascripts/gantt.js
+++ b/public/javascripts/gantt.js
@@ -162,25 +162,31 @@ function drawGanttProgressLines() {
 }
 
 function drawSelectedColumns(){
-  if(isMobile()) {
-    $('td.gantt_selected_column').each(function(i) {
-      $(this).hide();
-    });
-  }else{
-    $('#content').addClass("gantt_content");
-    $('td.gantt_selected_column').each(function() {
-      $(this).show();
-      var column_name = $(this).attr('id');
-      $(this).resizable({
-        alsoResize: `.gantt_${column_name}_container, .gantt_${column_name}_container > .gantt_hdr`,
-        minWidth: 20,
-        handles: "e",
-        create: function( event, ui ) {
-          $(".ui-resizable-e").css("cursor","ew-resize");
-        }
-      }).on('resize', function (e) {
-          e.stopPropagation();
+  if ($("#draw_selected_columns").prop('checked')) {
+    if(isMobile()) {
+      $('td.gantt_selected_column').each(function(i) {
+        $(this).hide();
       });
+    }else{
+      $('#content').addClass("gantt_content");
+      $('td.gantt_selected_column').each(function() {
+        $(this).show();
+        var column_name = $(this).attr('id');
+        $(this).resizable({
+          alsoResize: `.gantt_${column_name}_container, .gantt_${column_name}_container > .gantt_hdr`,
+          minWidth: 20,
+          handles: "e",
+          create: function( event, ui ) {
+            $(".ui-resizable-e").css("cursor","ew-resize");
+          }
+        }).on('resize', function (e) {
+            e.stopPropagation();
+        });
+      });
+    }
+  }else{
+    $('td.gantt_selected_column').each(function (i) {
+      $(this).hide();
     });
   }
 }
diff --git a/test/functional/queries_controller_test.rb b/test/functional/queries_controller_test.rb
index 0e4e64696..2b9af347d 100644
--- a/test/functional/queries_controller_test.rb
+++ b/test/functional/queries_controller_test.rb
@@ -258,7 +258,8 @@ class QueriesControllerTest < Redmine::ControllerTest
           :query => {
             :name => "test_create_from_gantt",
             :draw_relations => '1',
-            :draw_progress_line => '1'
+            :draw_progress_line => '1',
+            :draw_selected_columns => '1'
           }
         }
       assert_response 302
@@ -267,6 +268,7 @@ class QueriesControllerTest < Redmine::ControllerTest
     assert_redirected_to "/issues/gantt?query_id=#{query.id}"
     assert_equal true, query.draw_relations
     assert_equal true, query.draw_progress_line
+    assert_equal true, query.draw_selected_columns
   end
 
   def test_create_project_query_from_gantt
@@ -284,7 +286,8 @@ class QueriesControllerTest < Redmine::ControllerTest
           :query => {
             :name => "test_create_from_gantt",
             :draw_relations => '0',
-            :draw_progress_line => '0'
+            :draw_progress_line => '0',
+            :draw_selected_columns => '0'
           }
         }
       assert_response 302
@@ -293,6 +296,7 @@ class QueriesControllerTest < Redmine::ControllerTest
     assert_redirected_to "/projects/ecookbook/issues/gantt?query_id=#{query.id}"
     assert_equal false, query.draw_relations
     assert_equal false, query.draw_progress_line
+    assert_equal false, query.draw_selected_columns
   end
 
   def test_create_project_public_query_should_force_private_without_manage_public_queries_permission
-- 
2.19.0.windows.1

